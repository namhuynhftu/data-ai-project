version: 2

models:
  - name: fact_orders_accumulating
    description: >
      **Accumulating snapshot fact table** tracking order lifecycle from purchase through delivery.
      
      **Business Purpose:** Monitor order fulfillment performance, delivery timeliness, and lifecycle metrics.
      
      **Grain:** One row per order (accumulating fact updates as order progresses through lifecycle)
      
      **Fact Type:** Accumulating Snapshot (multiple dates representing milestones)
    meta:
      owner: "Data Engineering Team"
      layer: "mart"
      criticality: "high"
      refresh_frequency: "hourly"
    columns:
      - name: order_id
        description: "Primary key - Unique order identifier"
        data_tests:
          - unique
          - not_null
      - name: customer_id
        description: "Foreign key to dim_customer"
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_customer')
                field: customer_id
      - name: order_status
        description: "Current order status (delivered, shipped, canceled, etc.)"
        data_tests:
          - not_null
      - name: purchase_date
        description: "Date when order was placed by customer"
        data_tests:
          - not_null
      - name: approved_date
        description: "Date when payment was approved"
      - name: carrier_date
        description: "Date when order was handed to carrier"
      - name: delivered_date
        description: "Date when order was delivered to customer"
      - name: estimated_date
        description: "Estimated delivery date promised to customer"
      - name: purchase_to_approve_days
        description: "Days between purchase and payment approval (lag metric)"
      - name: approve_to_ship_days
        description: "Days between approval and shipping (lag metric)"
      - name: ship_to_deliver_days
        description: "Days between shipping and delivery (lag metric)"
      - name: on_time_flag
        description: "Binary flag: 1 if delivered on/before estimated date, 0 otherwise"

  - name: fact_order_items
    description: >
      **Transaction fact table** containing individual line items for each order.
      
      **Business Purpose:** Detailed product sales analysis, revenue attribution, and item-level metrics.
      
      **Grain:** One row per order line item (order_id + order_item_id)
      
      **Fact Type:** Transaction Fact (immutable after order completion)
    meta:
      owner: "Data Engineering Team"
      layer: "mart"
      criticality: "high"
    columns:
      - name: order_item_key
        description: "Primary key - Surrogate key for order item (order_id + order_item_id)"
        data_tests:
          - unique
          - not_null
      - name: order_id
        description: "Foreign key to dim_order"
      - name: order_item_id
        description: "Line item number within the order"  
      - name: customer_key
        description: "Foreign key to dim_customer"
        data_tests:
          - relationships:
              arguments:
                to: ref('dim_customer')
                field: customer_key
      - name: seller_key
        description: "Foreign key to dim_seller"
        data_tests:
          - relationships:
              arguments:
                to: ref('dim_seller')
                field: seller_key
      - name: product_key
        description: "Foreign key to dim_product"
        data_tests:
          - relationships:
              arguments:
                to: ref('dim_product')
                field: product_key
      - name: purchase_date
        description: "Date when order was placed by customer"
      - name: delivery_date
        description: "Date when order was delivered to customer"
      - name: shipping_limit_date
        description: "Date by which the order should be shipped"
      - name: freight_value
        description: "Freight cost for the order item"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true
      - name: total_item_value
        description: "Total value for the order item (price + freight)"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true
      - name: price
        description: "Price of the product at the time of order"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 0
              inclusive: true

  - name: fact_payments
    description: >
      **Transaction fact table** containing payment details for orders.
      
      **Business Purpose:** Payment method analysis, installment tracking, and revenue recognition.
      
      **Grain:** One row per payment transaction (order may have multiple payments)
      
      **Fact Type:** Transaction Fact
    meta:
      owner: "Data Engineering Team"
      layer: "mart"
    columns:
      - name: order_id
        description: "Order unique identifier"
        data_tests:
          - not_null
      - name: payment_sequential
        description: "Sequential number of the payment for the order"
      - name: payment_type_key
        description: "Foreign key to dim_payment_type"
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_payment_type')
                field: payment_type_key
      - name: payment_value
        description: "Monetary value of the payment"
      - name: payment_installments
        description: "Number of installments for the payment"
      - name: installment_value
        description: "Value of each installment"

  - name: fact_reviews
    description: >
      **Periodic snapshot fact table** containing customer reviews and ratings.
      
      **Business Purpose:** Customer satisfaction analysis, product quality insights, and sentiment tracking.
      
      **Grain:** One row per review (one customer can review multiple orders)
      
      **Fact Type:** Periodic Snapshot
    meta:
      owner: "Data Engineering Team"
      layer: "mart"
    columns:
      - name: review_key
        description: "Primary key - Unique review identifier"
        data_tests:
          - unique
          - not_null
      - name: review_id
        description: "Original review identifier from source system"
        data_tests:
          - not_null
      - name: order_id
        description: "Order unique identifier"
        data_tests:
          - not_null
      - name: review_score
        description: "Customer rating score for the order"
      - name: review_sentiment
        description: "Sentiment classification of the review text (positive, neutral, negative)"
      - name: review_creation_date
        description: "Date when the review was created"
      - name: review_answer_timestamp
        description: "Timestamp when the review was answered by the seller"
      - name: has_comment
        description: "Binary flag indicating if the review contains a comment"